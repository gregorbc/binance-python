<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Futures Bot v10 - Panel Profesional</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #111827; 
            --bg-light: #F9FAFB; 
            --primary: #1F2937; 
            --secondary: #4B5563; 
            --accent: #3B82F6; 
            --success: #10B981; 
            --danger: #EF4444; 
            --warning: #F59E0B; 
            --text-light: #D1D5DB; 
            --text-dark: #111827; 
            --border: #E5E7EB;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --bg-dark: #F9FAFB;
            --bg-light: #111827;
            --primary: #F3F4F6;
            --secondary: #E5E7EB;
            --accent: #60A5FA;
            --text-light: #1F2937;
            --text-dark: #D1D5DB;
            --border: #374151;
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-light); 
            color: var(--text-dark); 
            margin: 0; 
            line-height: 1.6;
            transition: var(--transition);
        }

        .container { 
            max-width: 1800px; 
            margin: 2rem auto; 
            padding: 0 2rem; 
        }

        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1.5rem; 
            background: var(--primary);
            color: var(--text-light);
            border-radius: 1rem; 
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .header h1 { 
            font-size: 1.5rem; 
            margin: 0; 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
        }

        .header h1 i { 
            color: var(--accent); 
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .status-indicator { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            font-weight: 600; 
        }

        .status-dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background-color: var(--secondary); 
            transition: background-color 0.3s; 
            position: relative;
        }

        .status-dot.running { 
            background-color: var(--success);
            animation: pulse 2s infinite;
        }

        .btn { 
            padding: 0.6rem 1.2rem; 
            border: none; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            font-weight: 600; 
            transition: var(--transition); 
            display: inline-flex; 
            align-items: center; 
            gap: 0.5rem; 
        }

        .btn i { 
            font-size: 0.9em; 
        }

        .btn-primary { 
            background-color: var(--accent); 
            color: white; 
        }

        .btn-primary:hover { 
            background-color: #2563EB; 
            transform: translateY(-2px);
        }

        .btn-danger { 
            background-color: var(--danger); 
            color: white; 
        }

        .btn-danger:hover { 
            background-color: #DC2626; 
            transform: translateY(-2px);
        }

        .btn-secondary { 
            background-color: var(--secondary); 
            color: white; 
        }

        .btn-secondary:hover {
            background-color: #374151;
            transform: translateY(-2px);
        }

        .btn-sm { 
            padding: 0.3rem 0.6rem; 
            font-size: 0.8rem; 
        }

        .btn:disabled { 
            background-color: #9CA3AF; 
            cursor: not-allowed; 
            transform: none !important;
        }

        .loader { 
            width: 16px; 
            height: 16px; 
            border: 2px solid #FFF; 
            border-bottom-color: transparent; 
            border-radius: 50%; 
            display: inline-block; 
            box-sizing: border-box; 
            animation: spin 1s linear infinite; 
        }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 1.5rem; 
            margin-bottom: 2rem; 
        }

        .stat-card { 
            background: var(--primary);
            color: var(--text-light);
            border-radius: 1rem; 
            padding: 1.5rem; 
            box-shadow: var(--card-shadow);
            animation: fadeIn 0.5s ease-out;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), transparent);
        }

        .stat-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .stat-title {
            font-size: 0.9rem;
            color: var(--text-light);
            opacity: 0.8;
        }

        .stat-value { 
            font-size: 1.8rem; 
            font-weight: 700; 
            margin-bottom: 0.5rem;
        }

        .stat-footer {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-light);
            opacity: 0.8;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            margin-right: 0.5rem;
        }

        .positive { 
            color: var(--success); 
        }

        .negative { 
            color: var(--danger); 
        }

        .main-grid { 
            display: grid; 
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem; 
        }

        .grid-col-span-6 { 
            grid-column: span 6;
        }

        .grid-col-span-4 {
            grid-column: span 4;
        }

        .grid-col-span-8 {
            grid-column: span 8;
        }

        .grid-col-span-12 {
            grid-column: span 12;
        }

        .card { 
            background: var(--primary);
            color: var(--text-light);
            border-radius: 1rem; 
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1.25rem 1.5rem; 
            border-bottom: 1px solid var(--border);
        }

        .card-title { 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin: 0; 
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .card-body { 
            padding: 1.5rem;
            flex-grow: 1;
            overflow: auto;
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
        }

        th, td { 
            padding: 1rem; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
            font-size: 0.9rem; 
        }

        th { 
            background-color: rgba(0, 0, 0, 0.1); 
            font-weight: 600; 
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .log-container { 
            height: 400px; 
            overflow-y: auto; 
            background: rgba(0, 0, 0, 0.2); 
            color: var(--text-light); 
            padding: 1rem; 
            border-radius: 0.5rem; 
            font-family: 'Fira Code', monospace; 
            font-size: 0.85rem; 
        }

        .log-container div { 
            padding: 0.2rem 0; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-container div:last-child {
            border-bottom: none;
        }

        .log-error { 
            color: var(--danger); 
        }

        .log-warning { 
            color: var(--warning); 
        }

        .log-info { 
            color: #93C5FD; 
        }

        .log-success {
            color: var(--success);
        }

        .config-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
        }

        .form-group { 
            display: flex; 
            flex-direction: column; 
        }

        .form-label { 
            font-size: 0.8rem; 
            margin-bottom: 0.25rem; 
            color: var(--text-light);
            opacity: 0.8;
            font-weight: 500; 
        }

        .form-control { 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            border: 1px solid var(--border); 
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-light);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.7); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            opacity: 0; 
            visibility: hidden; 
            transition: all 0.3s; 
        }

        .modal-overlay.visible { 
            opacity: 1; 
            visibility: visible; 
        }

        .modal-content { 
            background: var(--primary); 
            padding: 2rem; 
            border-radius: 1rem; 
            width: 90%; 
            max-width: 500px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            color: var(--text-light);
        }

        .modal-actions { 
            display: flex; 
            justify-content: flex-end; 
            gap: 1rem; 
            margin-top: 1.5rem; 
        }

        .toast-container { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            z-index: 1001; 
        }

        .toast { 
            background: var(--primary); 
            color: white; 
            padding: 1rem 1.5rem; 
            border-radius: 0.5rem; 
            margin-bottom: 1rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0; 
            transform: translateY(20px); 
            transition: all 0.3s; 
        }

        .toast.show { 
            opacity: 1; 
            transform: translateY(0); 
        }

        .toast.success { 
            background: var(--success); 
        }

        .toast.error { 
            background: var(--danger); 
        }

        .toast.info {
            background: var(--accent);
        }

        .toast i {
            font-size: 1.2rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            border-bottom: 2px solid var(--accent);
            color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
        }

        .search-box input {
            background: none;
            border: none;
            color: var(--text-light);
            padding: 0.5rem;
            width: 100%;
            outline: none;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success);
            color: white;
        }

        .badge-warning {
            background: var(--warning);
            color: white;
        }

        .badge-danger {
            background: var(--danger);
            color: white;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .grid-col-span-6,
            .grid-col-span-4,
            .grid-col-span-8 {
                grid-column: span 1;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
                margin: 1rem auto;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .header-actions {
                flex-direction: column;
                gap: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-robot"></i>Binance Futures Bot v10</h1>
            <div class="header-actions">
                <div class="status-indicator">
                    <div id="status-dot" class="status-dot"></div>
                    <span id="status-message">Conectando...</span>
                </div>
                <div class="status-indicator">
                    <i class="fas fa-wallet"></i>
                    <span id="header-balance">0.00 USDT</span>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="startBot(this)" id="start-btn"><i class="fas fa-play"></i>Iniciar</button>
                    <button class="btn btn-danger" onclick="stopBot(this)" id="stop-btn"><i class="fas fa-stop"></i>Detener</button>
                    <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">Balance Total</div>
                    <div class="stat-icon"><i class="fas fa-balance-scale"></i></div>
                </div>
                <div class="stat-value" id="balance-stat">0.00</div>
                <div class="stat-footer">
                    <span class="stat-trend"><i class="fas fa-caret-up positive"></i> 2.5%</span>
                    <span>Última actualización</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">Inversión Actual</div>
                    <div class="stat-icon"><i class="fas fa-briefcase"></i></div>
                </div>
                <div class="stat-value" id="investment-stat">0.00</div>
                <div class="stat-footer">
                    <span class="stat-trend"><i class="fas fa-caret-down negative"></i> 1.2%</span>
                    <span>En posiciones abiertas</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">Posiciones</div>
                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                </div>
                <div class="stat-value" id="positions-stat">0/20</div>
                <div class="stat-footer">
                    <span class="badge badge-success">Activas: 0</span>
                    <span>Límite: 20</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">P&L Abierto</div>
                    <div class="stat-icon"><i class="fas fa-chart-pie"></i></div>
                </div>
                <div class="stat-value" id="unrealized-pnl-stat">0.00</div>
                <div class="stat-footer">
                    <span class="stat-trend" id="unrealized-trend"><i class="fas fa-caret-up positive"></i> 0.0%</span>
                    <span>No realizado</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">P&L Realizado</div>
                    <div class="stat-icon"><i class="fas fa-piggy-bank"></i></div>
                </div>
                <div class="stat-value" id="realized-pnl-stat">0.00</div>
                <div class="stat-footer">
                    <span class="stat-trend" id="realized-trend"><i class="fas fa-caret-up positive"></i> 0.0%</span>
                    <span>Total acumulado</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">Total Trades</div>
                    <div class="stat-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                </div>
                <div class="stat-value" id="trades-stat">0</div>
                <div class="stat-footer">
                    <span class="badge badge-success">Ganadores: 0</span>
                    <span class="badge badge-danger">Perdedores: 0</span>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="card grid-col-span-8">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> Rendimiento del Bot</h3>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary">1D</button>
                        <button class="btn btn-sm btn-secondary">1S</button>
                        <button class="btn btn-sm btn-primary">1M</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card grid-col-span-4">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-info-circle"></i> Resumen de Trading</h3>
                </div>
                <div class="card-body">
                    <div class="stats-grid" style="grid-template-columns: 1fr;">
                        <div class="stat-card" style="padding: 1rem;">
                            <div class="stat-header">
                                <div class="stat-title">Ratio de Ganancia</div>
                                <div class="stat-value">0%</div>
                            </div>
                        </div>
                        <div class="stat-card" style="padding: 1rem;">
                            <div class="stat-header">
                                <div class="stat-title">Average Win</div>
                                <div class="stat-value">0.00</div>
                            </div>
                        </div>
                        <div class="stat-card" style="padding: 1rem;">
                            <div class="stat-header">
                                <div class="stat-title">Average Loss</div>
                                <div class="stat-value">0.00</div>
                            </div>
                        </div>
                        <div class="stat-card" style="padding: 1rem;">
                            <div class="stat-header">
                                <div class="stat-title">Profit Factor</div>
                                <div class="stat-value">0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card grid-col-span-6">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-map-marker-alt"></i> Posiciones Abiertas</h3>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" onclick="refreshData()"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="position-search" placeholder="Buscar símbolo..." oninput="filterPositions()">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Símbolo</th>
                                <th>Lado</th>
                                <th>Tamaño</th>
                                <th>Entrada</th>
                                <th>Actual</th>
                                <th>P&L (USDT)</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="positions-tbody">
                            <tr>
                                <td colspan="7" style="text-align:center; padding: 2rem;">Cargando posiciones...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card grid-col-span-6">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-history"></i> Historial de Trades</h3>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary">Exportar</button>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="tab-container">
                        <div class="tab active" onclick="changeTab(this, 'today')">Hoy</div>
                        <div class="tab" onclick="changeTab(this, 'week')">Esta Semana</div>
                        <div class="tab" onclick="changeTab(this, 'month')">Este Mes</div>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="trade-search" placeholder="Buscar trade..." oninput="filterTrades()">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Símbolo</th>
                                <th>Lado</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody id="trades-tbody">
                            <tr>
                                <td colspan="6" style="text-align:center; padding: 2rem;">No hay trades recientes</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card grid-col-span-12">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-cogs"></i> Configuración del Bot</h3>
                </div>
                <div class="card-body">
                    <div class="tab-container">
                        <div class="tab active" onclick="changeConfigTab(this, 'global')">Global</div>
                        <div class="tab" onclick="changeConfigTab(this, 'strategy')">Estrategia</div>
                        <div class="tab" onclick="changeConfigTab(this, 'manual')">Trading Manual</div>
                        <div class="tab" onclick="changeConfigTab(this, 'api')">API Keys</div>
                    </div>

                    <div id="global-config" class="tab-content active">
                        <div class="config-grid">
                            <div class="form-group">
                                <label class="form-label" for="LEVERAGE">Apalancamiento</label>
                                <input type="number" id="LEVERAGE" class="form-control" min="1" max="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="MAX_CONCURRENT_POS">Max Posiciones</label>
                                <input type="number" id="MAX_CONCURRENT_POS" class="form-control" min="1" max="50">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="FIXED_MARGIN_PER_TRADE_USDT">Margen por Trade (USDT)</label>
                                <input type="number" id="FIXED_MARGIN_PER_TRADE_USDT" class="form-control" step="0.1" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="NUM_SYMBOLS_TO_SCAN">Símbolos a Escanear</label>
                                <input type="number" id="NUM_SYMBOLS_TO_SCAN" class="form-control" min="1" max="500">
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="saveConfig(this, 'global')" style="margin-top: 1rem;">
                            <i class="fas fa-save"></i> Guardar Configuración Global
                        </button>
                    </div>

                    <div id="strategy-config" class="tab-content">
                        <div class="config-grid">
                            <div class="form-group">
                                <label class="form-label" for="ATR_MULT_SL">Multiplicador SL (ATR)</label>
                                <input type="number" id="ATR_MULT_SL" class="form-control" step="0.1" min="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="ATR_MULT_TP">Multiplicador TP (ATR)</label>
                                <input type="number" id="ATR_MULT_TP" class="form-control" step="0.1" min="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="FAST_EMA">EMA Rápida</label>
                                <input type="number" id="FAST_EMA" class="form-control" min="1" max="50">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="SLOW_EMA">EMA Lenta</label>
                                <input type="number" id="SLOW_EMA" class="form-control" min="1" max="100">
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="saveConfig(this, 'strategy')" style="margin-top: 1rem;">
                            <i class="fas fa-save"></i> Guardar Configuración de Estrategia
                        </button>
                    </div>

                    <div id="manual-config" class="tab-content">
                        <div class="config-grid">
                            <div class="form-group">
                                <label class="form-label" for="manual-symbol">Símbolo</label>
                                <input type="text" id="manual-symbol" class="form-control" placeholder="BTCUSDT">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="manual-side">Dirección</label>
                                <select id="manual-side" class="form-control">
                                    <option value="LONG">🟢 LONG</option>
                                    <option value="SHORT">🔴 SHORT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="manual-margin">Margen (USDT)</label>
                                <input type="number" id="manual-margin" class="form-control" value="10" min="1" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="manual-leverage">Apalancamiento</label>
                                <input type="number" id="manual-leverage" class="form-control" value="20" min="1" max="100">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="executeManualTrade(this)" style="margin-top: 1rem;">
                            <i class="fas fa-rocket"></i> Ejecutar Trade Manual
                        </button>
                    </div>

                    <div id="api-config" class="tab-content">
                        <div class="config-grid">
                            <div class="form-group">
                                <label class="form-label" for="api-key">API Key</label>
                                <input type="password" id="api-key" class="form-control" placeholder="Ingresa tu API Key">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="api-secret">API Secret</label>
                                <input type="password" id="api-secret" class="form-control" placeholder="Ingresa tu API Secret">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="form-check" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
                                <input type="checkbox" id="testnet-mode" class="form-check-input">
                                <label class="form-label" for="testnet-mode" style="margin: 0;">Modo Testnet</label>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="saveApiConfig(this)" style="margin-top: 1rem;">
                            <i class="fas fa-save"></i> Guardar Configuración API
                        </button>
                    </div>
                </div>
            </div>

            <div class="card grid-col-span-12">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-terminal"></i> Registro de Actividad</h3>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" onclick="clearLogs()"><i class="fas fa-trash"></i> Limpiar</button>
                        <button class="btn btn-sm btn-secondary" onclick="exportLogs()"><i class="fas fa-download"></i> Exportar</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="log-container" id="log-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmation-modal">
        <div class="modal-content">
            <h3 id="modal-title">Confirmar Acción</h3>
            <p id="modal-body">¿Estás seguro?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-cancel-btn">Cancelar</button>
                <button class="btn btn-danger" id="modal-confirm-btn">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <h3>Configuración Avanzada</h3>
            <div class="form-group">
                <label class="form-label" for="poll-interval">Intervalo de Actualización (ms)</label>
                <input type="number" id="poll-interval" class="form-control" value="5000" min="1000" step="1000">
            </div>
            <div class="form-group">
                <label class="form-label" for="alert-sound">Sonido de Alertas</label>
                <select id="alert-sound" class="form-control">
                    <option value="none">Ninguno</option>
                    <option value="beep">Beep</option>
                    <option value="chime">Chime</option>
                    <option value="bell">Campana</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="document.getElementById('settings-modal').classList.remove('visible')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveAdvancedSettings()">Guardar</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
        // Variables globales
        const API_BASE_URL = '';
        const socket = io(window.location.origin);
        let performanceChart = null;
        let currentTheme = 'light';
        let positionsData = [];
        let tradesData = [];

        // Inicialización cuando se carga la página
        window.onload = function() {
            initializeTheme();
            initializeCharts();
            loadInitialData();
            setupEventListeners();
        };

        // Función para inicializar el tema
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        // Función para cambiar el tema
        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Función para aplicar el tema
        function setTheme(theme) {
            currentTheme = theme;
            const body = document.body;
            const themeIcon = document.getElementById('theme-toggle').querySelector('i');
            
            if (theme === 'dark') {
                body.classList.add('dark-mode');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                body.classList.remove('dark-mode');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        // Función para inicializar los gráficos
        function initializeCharts() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Balance',
                        data: [],
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Función para cargar datos iniciales
        function loadInitialData() {
            fetchInitialState();
            loadHistoricalData();
        }

        // Función para configurar event listeners
        function setupEventListeners() {
            document.getElementById('modal-cancel-btn').addEventListener('click', function() {
                document.getElementById('confirmation-modal').classList.remove('visible');
            });

            // Configurar el buscador de posiciones
            document.getElementById('position-search').addEventListener('input', filterPositions);
            
            // Configurar el buscador de trades
            document.getElementById('trade-search').addEventListener('input', filterTrades);
        }

        // Función para cambiar pestaña
        function changeTab(tabElement, tabName) {
            // Desactivar todas las pestañas
            const tabs = tabElement.parentElement.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Activar la pestaña seleccionada
            tabElement.classList.add('active');
            
            // Aquí puedes cargar los datos de la pestaña seleccionada
            // Por ahora solo es un ejemplo
            console.log('Cambiando a pestaña:', tabName);
        }

        // Función para cambiar pestaña de configuración
        function changeConfigTab(tabElement, tabName) {
            // Desactivar todas las pestañas
            const tabs = tabElement.parentElement.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Ocultar todos los contenidos
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Activar la pestaña seleccionada
            tabElement.classList.add('active');
            
            // Mostrar el contenido correspondiente
            document.getElementById(tabName + '-config').classList.add('active');
        }

        // Función para formatear valores monetarios
        function formatCurrency(value, decimals = 2) { 
            return parseFloat(value || 0).toFixed(decimals); 
        }

        // Función para formatear números grandes
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return num;
        }

        // Función para actualizar la interfaz
        function updateUI(state) {
            const isRunning = state.running;
            document.getElementById('status-message').textContent = state.status_message || 'Detenido';
            document.getElementById('status-dot').classList.toggle('running', isRunning);
            document.getElementById('start-btn').disabled = isRunning;
            document.getElementById('stop-btn').disabled = !isRunning;
            
            document.getElementById('header-balance').textContent = `${formatCurrency(state.balance)} USDT`;
            document.getElementById('balance-stat').textContent = formatCurrency(state.balance);
            document.getElementById('investment-stat').textContent = formatCurrency(state.total_investment_usd);
            
            const openPositions = Object.keys(state.open_positions || {}).length;
            const maxPositions = state.config?.MAX_CONCURRENT_POS || 20;
            document.getElementById('positions-stat').textContent = `${openPositions}/${maxPositions}`;
            
            const totalUnrealizedPnl = Object.values(state.open_positions || {}).reduce((acc, pos) => acc + parseFloat(pos.unRealizedProfit || pos.unrealizedProfit || 0), 0);
            const unrealizedPnlEl = document.getElementById('unrealized-pnl-stat');
            unrealizedPnlEl.textContent = formatCurrency(totalUnrealizedPnl);
            unrealizedPnlEl.className = `stat-value ${totalUnrealizedPnl >= 0 ? 'positive' : 'negative'}`;
            
            // Actualizar tendencia del P&L no realizado
            const unrealizedTrendEl = document.getElementById('unrealized-trend');
            if (totalUnrealizedPnl >= 0) {
                unrealizedTrendEl.innerHTML = '<i class="fas fa-caret-up positive"></i> ' + formatCurrency(totalUnrealizedPnl) + '%';
            } else {
                unrealizedTrendEl.innerHTML = '<i class="fas fa-caret-down negative"></i> ' + formatCurrency(Math.abs(totalUnrealizedPnl)) + '%';
            }
            
            const perf = state.performance_stats || {};
            const realizedPnlEl = document.getElementById('realized-pnl-stat');
            realizedPnlEl.textContent = formatCurrency(perf.realized_pnl);
            realizedPnlEl.className = `stat-value ${perf.realized_pnl >= 0 ? 'positive' : 'negative'}`;
            
            // Actualizar tendencia del P&L realizado
            const realizedTrendEl = document.getElementById('realized-trend');
            if (perf.realized_pnl >= 0) {
                realizedTrendEl.innerHTML = '<i class="fas fa-caret-up positive"></i> ' + formatCurrency(perf.realized_pnl) + '%';
            } else {
                realizedTrendEl.innerHTML = '<i class="fas fa-caret-down negative"></i> ' + formatCurrency(Math.abs(perf.realized_pnl)) + '%';
            }
            
            document.getElementById('trades-stat').textContent = perf.trades_count || 0;
            
            if (state.config) {
                ['LEVERAGE', 'MAX_CONCURRENT_POS', 'FIXED_MARGIN_PER_TRADE_USDT', 'NUM_SYMBOLS_TO_SCAN', 'ATR_MULT_SL', 'ATR_MULT_TP'].forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = state.config[key];
                });
            }
            
            // Guardar datos de posiciones para filtrado
            positionsData = Object.values(state.open_positions || {});
            updatePositionsTable(positionsData);
            
            // Actualizar gráfico de rendimiento
            updatePerformanceChart(state.balance);
        }

        // Función para actualizar la tabla de posiciones
        function updatePositionsTable(positions) {
            const tbody = document.getElementById('positions-tbody');
            tbody.innerHTML = positions.length === 0 
                ? '<tr><td colspan="7" style="text-align:center; padding: 2rem;">No hay posiciones abiertas.</td></tr>'
                : positions.map(pos => {
                    const pnl = parseFloat(pos.unRealizedProfit || pos.unrealizedProfit || 0);
                    const side = parseFloat(pos.positionAmt) > 0 ? 'LONG' : 'SHORT';
                    const entryPrice = parseFloat(pos.entryPrice);
                    const markPrice = parseFloat(pos.markPrice);
                    const priceChange = ((markPrice - entryPrice) / entryPrice) * 100;
                    
                    return `<tr>
                        <td><strong>${pos.symbol}</strong></td>
                        <td><span class="${side === 'LONG' ? 'positive' : 'negative'}">${side}</span></td>
                        <td>${formatCurrency(Math.abs(pos.positionAmt), 4)}</td>
                        <td>${formatCurrency(entryPrice, 4)}</td>
                        <td>${formatCurrency(markPrice, 4)} <span class="${priceChange >= 0 ? 'positive' : 'negative'}">(${formatCurrency(priceChange)}%)</span></td>
                        <td id="pnl-${pos.symbol}" class="${pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pnl)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="confirmClosePosition('${pos.symbol}')">
                                <i class="fas fa-times"></i> Cerrar
                            </button>
                        </td>
                    </tr>`;
                }).join('');
        }

        // Función para filtrar posiciones
        function filterPositions() {
            const searchTerm = document.getElementById('position-search').value.toLowerCase();
            const filteredPositions = positionsData.filter(pos => 
                pos.symbol.toLowerCase().includes(searchTerm)
            );
            updatePositionsTable(filteredPositions);
        }

        // Función para filtrar trades
        function filterTrades() {
            const searchTerm = document.getElementById('trade-search').value.toLowerCase();
            // Esta función se implementará cuando se carguen los trades
            console.log('Filtrando trades por:', searchTerm);
        }

        // Función para actualizar el gráfico de rendimiento
        function updatePerformanceChart(balance) {
            if (!performanceChart) return;
            
            // Agregar nuevo punto de datos
            const now = new Date();
            const timeLabel = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
            
            performanceChart.data.labels.push(timeLabel);
            performanceChart.data.datasets[0].data.push(balance);
            
            // Mantener un número limitado de puntos de datos
            const maxDataPoints = 20;
            if (performanceChart.data.labels.length > maxDataPoints) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets[0].data.shift();
            }
            
            performanceChart.update();
        }

        // Función para agregar entrada al log
        function addLogEntry(message, level = 'info') {
            const logContainer = document.getElementById('log-container');
            const sanitizedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const time = new Date().toLocaleTimeString();
            let logClass = '';
            let icon = '';
            
            if (level.includes('error')) {
                logClass = 'log-error';
                icon = '<i class="fas fa-exclamation-circle"></i> ';
            } else if (level.includes('warning')) {
                logClass = 'log-warning';
                icon = '<i class="fas fa-exclamation-triangle"></i> ';
            } else if (level.includes('info')) {
                logClass = 'log-info';
                icon = '<i class="fas fa-info-circle"></i> ';
            } else if (level.includes('success')) {
                logClass = 'log-success';
                icon = '<i class="fas fa-check-circle"></i> ';
            }
            
            logContainer.innerHTML += `<div class="${logClass}"><span style="color: #6B7280;">[${time}]</span> ${icon}${sanitizedMessage}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Función para mostrar notificación toast
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let icon = '';
            
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                default:
                    icon = '<i class="fas fa-info-circle"></i>';
            }
            
            toast.className = `toast ${type}`;
            toast.innerHTML = `${icon} ${message}`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }, 10);
        }

        // Función para llamar a la API
        async function apiCall(endpoint, options = {}, button = null) {
            if (button) {
                button.disabled = true;
                button.innerHTML = '<span class="loader"></span> Procesando...';
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const responseData = await response.json().catch(() => ({ message: 'Respuesta no válida del servidor' }));
                
                if (!response.ok) {
                    throw new Error(responseData.message || `Error ${response.status}`);
                }
                
                if (responseData.message) {
                    showToast(responseData.message, 'success');
                }
                
                return responseData;
            } catch (error) {
                showToast(error.message, 'error');
                addLogEntry(`❌ Error en API (${endpoint}): ${error.message}`, 'error');
                throw error;
            } finally {
                if (button) {
                    button.disabled = false;
                    button.innerHTML = button.dataset.originalText;
                }
            }
        }

        // Función para configurar botones
        function setupButton(button, action) {
            button.dataset.originalText = button.innerHTML;
            action(button);
        }

        // Función para iniciar el bot
        async function startBot(btn) { 
            setupButton(btn, () => apiCall('/api/start', { method: 'POST' }, btn)); 
        }

        // Función para detener el bot
        async function stopBot(btn) { 
            setupButton(btn, () => apiCall('/api/stop', { method: 'POST' }, btn)); 
        }
        
        // Función para guardar configuración
        async function saveConfig(btn, type) {
            const keys = type === 'global' 
                ? ['LEVERAGE', 'MAX_CONCURRENT_POS', 'FIXED_MARGIN_PER_TRADE_USDT', 'NUM_SYMBOLS_TO_SCAN']
                : ['ATR_MULT_SL', 'ATR_MULT_TP'];
                
            const config = keys.reduce((acc, key) => {
                acc[key] = document.getElementById(key).value;
                return acc;
            }, {});
            
            setupButton(btn, () => apiCall('/api/update_config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            }, btn));
        }

        // Función para ejecutar trade manual
        async function executeManualTrade(btn) {
            const trade = {
                symbol: document.getElementById('manual-symbol').value.toUpperCase(),
                side: document.getElementById('manual-side').value,
                margin: document.getElementById('manual-margin').value,
                leverage: document.getElementById('manual-leverage').value
            };
            
            if (!trade.symbol) {
                showToast('Por favor, introduce un símbolo.', 'error');
                return;
            }
            
            setupButton(btn, () => apiCall('/api/manual_trade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(trade)
            }, btn));
        }

        // Función para confirmar cierre de posición
        function confirmClosePosition(symbol) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('modal-title').textContent = `Cerrar Posición`;
            document.getElementById('modal-body').textContent = `¿Está seguro que desea cerrar la posición en ${symbol}? Esta acción es irreversible.`;
            modal.classList.add('visible');

            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            const close = () => modal.classList.remove('visible');
            
            confirmBtn.onclick = async () => {
                close();
                await apiCall('/api/close_position', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
            };
            
            cancelBtn.onclick = close;
        }

        // Función para cargar el estado inicial
        async function fetchInitialState() {
            try {
                const initialState = await apiCall('/api/status');
                updateUI(initialState);
            } catch (e) {
                console.error("Error al cargar estado inicial", e);
            }
        }

        // Función para cargar datos históricos
        async function loadHistoricalData() {
            try {
                // Aquí cargarías datos históricos para el gráfico y el historial de trades
                // Por ahora es solo un ejemplo
                const historicalData = await apiCall('/api/history');
                if (historicalData) {
                    // Procesar datos históricos
                    tradesData = historicalData.trades || [];
                    updateTradesTable(tradesData);
                }
            } catch (e) {
                console.error("Error al cargar datos históricos", e);
            }
        }

        // Función para actualizar la tabla de trades
        function updateTradesTable(trades) {
            const tbody = document.getElementById('trades-tbody');
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">No hay trades recientes</td></tr>';
                return;
            }
            
            tbody.innerHTML = trades.map(trade => {
                const pnl = parseFloat(trade.realizedPnl || 0);
                const date = new Date(trade.time).toLocaleDateString();
                
                return `<tr>
                    <td>${date}</td>
                    <td>${trade.symbol}</td>
                    <td><span class="${trade.side === 'BUY' ? 'positive' : 'negative'}">${trade.side}</span></td>
                    <td>${formatCurrency(trade.qty, 4)}</td>
                    <td>${formatCurrency(trade.price, 4)}</td>
                    <td class="${pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pnl)}</td>
                </tr>`;
            }).join('');
        }

        // Función para refrescar datos
        function refreshData() {
            fetchInitialState();
            showToast('Datos actualizados', 'success');
        }

        // Función para limpiar logs
        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            addLogEntry('Registros limpiados manualmente', 'info');
        }

        // Función para exportar logs
        function exportLogs() {
            showToast('Función de exportación en desarrollo', 'info');
        }

        // Función para guardar configuración API
        function saveApiConfig(btn) {
            showToast('Configuración API guardada', 'success');
        }

        // Función para guardar configuración avanzada
        function saveAdvancedSettings() {
            showToast('Configuración avanzada guardada', 'success');
            document.getElementById('settings-modal').classList.remove('visible');
        }

        // Configuración de Socket.IO
        socket.on('connect', () => {
            addLogEntry('✅ Conectado al servidor.', 'success');
            showToast('Conexión establecida con el servidor', 'success');
        });
        
        socket.on('disconnect', () => {
            addLogEntry('❌ Desconectado del servidor.', 'warning');
            showToast('Conexión perdida con el servidor', 'error');
        });
        
        socket.on('connect_error', (err) => {
            addLogEntry(`❌ Error de conexión: ${err.message}`, 'error');
        });
        
        socket.on('status_update', updateUI);
        
        socket.on('config_updated', () => {
            addLogEntry('⚙️ Configuración actualizada desde el servidor.', 'info');
        });
        
        socket.on('log_update', (data) => {
            addLogEntry(data.message, data.level.toLowerCase());
        });
        
        socket.on('pnl_update', (pnlData) => {
            Object.entries(pnlData).forEach(([symbol, pnl]) => {
                const pnlCell = document.getElementById(`pnl-${symbol}`);
                if (pnlCell) {
                    pnlCell.textContent = formatCurrency(pnl);
                    pnlCell.className = pnl >= 0 ? 'positive' : 'negative';
                }
            });
        });

        // Solicitar datos iniciales
        fetchInitialState();
    </script>
</body>
</html>
